<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Profiling - Call Graph | 8st and the black cats</title><meta name="author" content="8st"><meta name="copyright" content="8st"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Performance is a key reason we use C++ for development. Although it should be fast enough for most circumstances, there’s always a need for faster speed in fields like quant trading or machine learnin">
<meta property="og:type" content="article">
<meta property="og:title" content="Profiling - Call Graph">
<meta property="og:url" content="https://kch042.github.io/posts/profiling-callgraph/index.html">
<meta property="og:site_name" content="8st and the black cats">
<meta property="og:description" content="Performance is a key reason we use C++ for development. Although it should be fast enough for most circumstances, there’s always a need for faster speed in fields like quant trading or machine learnin">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://kch042.github.io/img/run.png">
<meta property="article:published_time" content="2025-06-29T16:00:00.000Z">
<meta property="article:modified_time" content="2025-06-29T16:00:00.000Z">
<meta property="article:author" content="8st">
<meta property="article:tag" content="profiling">
<meta property="article:tag" content="perf">
<meta property="article:tag" content="call graph">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kch042.github.io/img/run.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Profiling - Call Graph",
  "url": "https://kch042.github.io/posts/profiling-callgraph/",
  "image": "https://kch042.github.io/img/run.png",
  "datePublished": "2025-06-29T16:00:00.000Z",
  "dateModified": "2025-06-29T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "8st",
      "url": "https://kch042.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://kch042.github.io/posts/profiling-callgraph/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '複製成功',
    error: '複製失敗',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '載入更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Profiling - Call Graph',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background: black;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/cpp.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">28</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-file"></i><span> Posts</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-address-card"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/run.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">8st and the black cats</span></a><a class="nav-page-title" href="/"><span class="site-name">Profiling - Call Graph</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-file"></i><span> Posts</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-address-card"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Profiling - Call Graph</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2025-06-29T16:00:00.000Z" title="發表於 2025-06-30 00:00:00">2025-06-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2025-06-29T16:00:00.000Z" title="更新於 2025-06-30 00:00:00">2025-06-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/HPC/">HPC</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">總字數:</span><span class="word-count">2.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀時間:</span><span>13分鐘</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>Performance is a key reason we use C++ for development. Although it should be fast enough for most circumstances, there’s always a need for faster speed in fields like quant trading or machine learning. </p>
<p>To evaluate the performance of a program, the most intuitive way is to measure its running time. We could use tools like linux <code>time</code> to do that. However, this way is more like giving us an overall score of the performance, lacking the individual components of the score. We are interested in the breakdown of the program, and most importantly, its bottleneck. </p>
<p>And here come’s the linux perf tool.</p>
<h1 id="Perf-Tool"><a href="#Perf-Tool" class="headerlink" title="Perf Tool"></a>Perf Tool</h1><p><code>perf</code> is a built-in profiling tool on Linux. It provides us with useful information such as </p>
<ul>
<li>L1 data cache misses</li>
<li>L1 instruction cache misses</li>
<li>number of branches</li>
<li>page fault rate</li>
<li>context switch rate</li>
<li>IPC (instruction per cycle)</li>
</ul>
<p>Besides the statistics it shown above, it also provides fine-grained timing by sampling and capturing events during the program run. This allows us the track the function calls with their call time and figure out the program hot spot.</p>
<h1 id="Stack-Trace"><a href="#Stack-Trace" class="headerlink" title="Stack Trace"></a>Stack Trace</h1><p>Stack trace is the call history of functions. For example, <code>main()</code> calls <code>func1()</code> which then calls <code>func2()</code>, then <code>main -&gt; func1 -&gt; fun2</code> is a stack trace.</p>
<p>There are 3 main methods for capturing the stack trace.</p>
<ul>
<li>fp (frame pointer)</li>
<li>dwarf</li>
<li>lbr (last branch record)</li>
</ul>
<h2 id="fp"><a href="#fp" class="headerlink" title="fp"></a>fp</h2><p>In modern CPU, it has a register called frame pointer that records the start address of current function frame. For every function frame, it will store the pointer of the previous frame. In this way, we could get the stack trace using a reasonable effort.</p>
<p>However, compiler may often do some optimization trick that could get us incorrect stack traces. For example, for functions with <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/22037261/what-does-sibling-calls-mean">tail calls</a>, compiler might make use of the same frames for them. Another example is inlining functions. In this way, we are unable to capture stack traces correctly. </p>
<p><strong>We could disable these optimization by adding the compiler flags <code>-fno-omit-frame-pointer</code>, <code>-fno-omit-frame-pointer</code> and <code>-fno-inline</code></strong></p>
<h2 id="dwarf"><a href="#dwarf" class="headerlink" title="dwarf"></a>dwarf</h2><p>A method to collect most detailed stack trace. <strong>It is the most accurate.</strong></p>
<p>However, it is has the most heavy overhead and not practical for large program profiling.</p>
<h2 id="lbr"><a href="#lbr" class="headerlink" title="lbr"></a>lbr</h2><p>This requires hardware support. In some processor, it has a register to store the from&#x2F;to addresses for branch instructions. We could collect stack trace by capturing values from this register.</p>
<p>The advantage is that the overhead is low, but it is not suitable for tracing deep stack since it’s relying on the LBR register and the register has a limited space.</p>
<h1 id="Symbols"><a href="#Symbols" class="headerlink" title="Symbols"></a>Symbols</h1><p>Every variable, function, class, has a unique name. We call them symbols. </p>
<p>In the stack trace collected, we only have addresses. To translate them back to human-readable names, we need the symbol table which maps the symbol name to its address. </p>
<p>We could check with the <code>nm</code> command to see if the symbol table exists in the binary</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># without symbol table</span></span><br><span class="line">$ root@50e0b03b2104:~# nm main</span><br><span class="line">nm: callgraph: no symbols</span><br><span class="line"></span><br><span class="line"><span class="comment"># with symbol table</span></span><br><span class="line">$ root@50e0b03b2104:~# nm main</span><br><span class="line">nm: callgraph: no symbols</span><br><span class="line">0000000000000908 T A</span><br><span class="line">0000000000000864 T B</span><br><span class="line">00000000000007c0 T C</span><br><span class="line">0000000000000724 T D</span><br><span class="line">0000000000010dc8 a _DYNAMIC</span><br><span class="line">0000000000010fa8 a _GLOBAL_OFFSET_TABLE_</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>In short, it is recommended to compile the program under test with <code>-g</code> flag and do NOT strip it.</strong> (With <code>-g</code>, we will have more debugging information and stripping removes the symbol table from the binary.)</p>
<h1 id="Call-Graph"><a href="#Call-Graph" class="headerlink" title="Call Graph"></a>Call Graph</h1><p>This section describes how to analyze the stack trace and interpret the call graphs. I am taking the terminology and ideas from this amazing <a target="_blank" rel="noopener" href="https://zh-blog.logan.tw/2019/10/06/intro-to-perf-events-and-call-graph/">blog</a>, just adding some personal interpretation based on these. </p>
<p>First, we can think of a stack trace, or part of it, as a <strong>path</strong>.</p>
<p>Suppose we want to know the function <code>A()</code>, we have two types of call graph and they focuses on different points.</p>
<ul>
<li>Caller-Based: What’s the time of each path <strong>starting at</strong> <code>A()</code></li>
<li>Callee-Based: What’s the time of each path <strong>ending at</strong> <code>A()</code></li>
</ul>
<p><img src="/img/pc/perf1.png"></p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>Let’s reuse the program in the <a target="_blank" rel="noopener" href="https://zh-blog.logan.tw/2019/10/06/intro-to-perf-events-and-call-graph/">blog</a> with some slight modification.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE ((4 * 1024 * 1024))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_ROUNDS 256</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> data[SIZE];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMPUTE(N, CH) \</span></span><br><span class="line"><span class="meta">  do &#123; \</span></span><br><span class="line"><span class="meta">    unsigned i, j; \</span></span><br><span class="line"><span class="meta">    for (j = 0; j &lt; (N); ++j) &#123; \</span></span><br><span class="line"><span class="meta">      for (i = 0; i &lt; SIZE; ++i) &#123; \</span></span><br><span class="line"><span class="meta">        data[i] = CH + i + j; \</span></span><br><span class="line"><span class="meta">      &#125; \</span></span><br><span class="line"><span class="meta">      escape(data); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__attribute__((always_inline))</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">escape</span><span class="params">(<span class="type">void</span> *p)</span> </span>&#123;</span><br><span class="line">  <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(<span class="string">&quot;&quot;</span> : : <span class="string">&quot;r&quot;</span>(p) : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__attribute__((noinline))</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">D</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">COMPUTE</span>(<span class="number">1</span>, <span class="string">&#x27;D&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__attribute__((noinline))</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">C</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">D</span>();</span><br><span class="line">  <span class="built_in">COMPUTE</span>(NUM_ROUNDS, <span class="string">&#x27;C&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__attribute__((noinline))</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">COMPUTE</span>(NUM_ROUNDS, <span class="string">&#x27;B&#x27;</span>);</span><br><span class="line">  <span class="built_in">C</span>();</span><br><span class="line">  <span class="built_in">C</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__attribute__((noinline))</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">COMPUTE</span>(NUM_ROUNDS, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">  <span class="built_in">B</span>();</span><br><span class="line">  <span class="built_in">C</span>();</span><br><span class="line">  <span class="built_in">B</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((noinline))</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">W</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">COMPUTE</span>(NUM_ROUNDS, <span class="string">&#x27;W&#x27;</span>);</span><br><span class="line">  <span class="built_in">A</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">COMPUTE</span>(NUM_ROUNDS, <span class="string">&#x27;M&#x27;</span>);</span><br><span class="line">  <span class="built_in">A</span>();</span><br><span class="line">  <span class="built_in">A</span>();</span><br><span class="line">  <span class="built_in">W</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The time line looks like this<br><img src="/img/pc/perf2.png"></p>
<p>First let’s obtain caller-based graph.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># collect stack traces and output to perf.data file</span></span><br><span class="line"><span class="comment"># using dwarf here for the most accurate results</span></span><br><span class="line">$ perf record -F 199 -g --call-graph dwarf ./callgraph</span><br><span class="line"></span><br><span class="line"><span class="comment"># read perf.data and output call graphs to stdout</span></span><br><span class="line"><span class="comment"># default output caller-based graphs</span></span><br><span class="line">$ perf report --stdio</span><br></pre></td></tr></table></figure>

<p>The output contains call graphs starting from every function. For the first line of each graph, it<br>displays the header information. For example, let’s look at the graph of <code>main</code>. </p>
<p>As we can see, we have 4.07% of time inside <code>main()</code> frame and 95.93% of time in its desendant functions of <code>main()</code>. We have 62.23% + 31.02% &#x3D; 93.25% of time in <code>A()</code> or its descendant functions.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Children      Self  Command    Shared Object  Symbol               </span></span><br><span class="line"><span class="comment"># ........  ........  .........  .............  .....................</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">   100.00%     4.07%  callgraph  callgraph      [.] main</span><br><span class="line">            |          </span><br><span class="line">            |--95.93%--main</span><br><span class="line">            |          |          </span><br><span class="line">            |          |--62.23%--A</span><br><span class="line">            |          |          |          </span><br><span class="line">            |          |          |--48.72%--B</span><br><span class="line">            |          |          |          |          </span><br><span class="line">            |          |          |           --32.56%--C</span><br><span class="line">            |          |          |          </span><br><span class="line">            |          |           --8.11%--C</span><br><span class="line">            |          |          </span><br><span class="line">            |           --33.70%--W</span><br><span class="line">            |                     |          </span><br><span class="line">            |                      --31.02%--A</span><br><span class="line">            |                                |          </span><br><span class="line">            |                                |--24.30%--B</span><br><span class="line">            |                                |          |          </span><br><span class="line">            |                                |           --16.22%--C</span><br><span class="line">            |                                |          </span><br><span class="line">            |                                 --4.04%--C</span><br><span class="line">            |          </span><br><span class="line">             --4.07%--_start</span><br><span class="line">                       __libc_start_main</span><br><span class="line">                       main</span><br></pre></td></tr></table></figure>

<p>To see how many time is spent in <code>A()</code> but not its descendant functions. Let’s look at <code>A()</code>‘s call graph, and we can see 8.08% of time are spent in <code>A()</code> (i.e. <code>main -&gt; A</code> and <code>main -&gt; W -&gt; A</code>)  but not its descendant functions.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Children      Self  Command    Shared Object  Symbol               </span></span><br><span class="line"><span class="comment"># ........  ........  .........  .............  .....................</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">    93.25%     8.08%  callgraph  callgraph      [.] A</span><br><span class="line">            |          </span><br><span class="line">            |--85.17%--A</span><br><span class="line">            |          |          </span><br><span class="line">            |          |--73.02%--B</span><br><span class="line">            |          |          |          </span><br><span class="line">            |          |           --48.78%--C</span><br><span class="line">            |          |          </span><br><span class="line">            |           --12.15%--C</span><br><span class="line">            |          </span><br><span class="line">             --8.08%--_start</span><br><span class="line">                       __libc_start_main</span><br><span class="line">                       main</span><br><span class="line">                       |          </span><br><span class="line">                       |--5.40%--A</span><br><span class="line">                       |          </span><br><span class="line">                        --2.68%--W</span><br><span class="line">                                  A</span><br></pre></td></tr></table></figure>

<p><img src="/img/pc/perf3.png"></p>
<p>If we were to see the how much time for <code>main -&gt; A</code> and <code>main -&gt; W -&gt; A</code> respectively, we can get A’s callee-based graph.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ perf report --no-children --stdio</span><br><span class="line">...</span><br><span class="line"><span class="comment"># Overhead  Command    Shared Object  Symbol              </span></span><br><span class="line"><span class="comment"># ........  .........  .............  ....................</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">...</span><br><span class="line">     8.08%  callgraph  callgraph      [.] A</span><br><span class="line">            |</span><br><span class="line">            ---A</span><br><span class="line">               |          </span><br><span class="line">               |--5.40%--main</span><br><span class="line">               |          __libc_start_main</span><br><span class="line">               |          _start</span><br><span class="line">               |          </span><br><span class="line">                --2.68%--W</span><br><span class="line">                          main</span><br><span class="line">                          __libc_start_main</span><br><span class="line">                          _start</span><br></pre></td></tr></table></figure>

<p>We can see that 5.4% of time is spent in <code>main -&gt; A</code> and 2.68% of time for <code>main -&gt; W -&gt; A</code>, which sums up to exactly 8.08%.</p>
<h1 id="Case-Study-Combination-Sum"><a href="#Case-Study-Combination-Sum" class="headerlink" title="Case Study: Combination Sum"></a>Case Study: Combination Sum</h1><p>In practice, we usually profile with large programs. But for demo purpose, I will show a simple one, even though it took me much time to debug when I first time seen it.</p>
<p>Suppose we are given an integer array <code>nums</code> and a number <code>target</code>, and we would like to know if we are able to pick some numbers from <code>nums</code> that sums up to <code>target</code>.</p>
<p>It’s a very simple problem, and should be familiar with everyone who has learnt algorithms. And here’s the program I wrote when I first faced it.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;numeric&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">combinationSum</span><span class="params">(std::vector&lt;<span class="type">int</span>&gt; nums, <span class="type">int</span> target, <span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (target == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (i == nums.<span class="built_in">size</span>() || target &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">combinationSum</span>(nums, target, i + <span class="number">1</span>) ||</span><br><span class="line">         <span class="built_in">combinationSum</span>(nums, target - nums[i], i + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// test data</span></span><br><span class="line">  <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">nums</span><span class="params">(<span class="number">25</span>)</span></span>;</span><br><span class="line">  std::<span class="built_in">iota</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>(), <span class="number">1</span>);</span><br><span class="line">  <span class="type">int</span> target = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">combinationSum</span>(nums, target, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s first get the overall performance</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ perf <span class="built_in">stat</span> ./main</span><br><span class="line"></span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">&#x27;./main&#x27;</span>:</span><br><span class="line"></span><br><span class="line">       2296.484151      task-clock:u (msec)       <span class="comment">#    0.999 CPUs utilized          </span></span><br><span class="line">                 0      context-switches:u        <span class="comment">#    0.000 K/sec                  </span></span><br><span class="line">                 0      cpu-migrations:u          <span class="comment">#    0.000 K/sec                  </span></span><br><span class="line">               117      page-faults:u             <span class="comment">#    0.051 K/sec                  </span></span><br><span class="line">        7756480407      cycles:u                  <span class="comment">#    3.378 GHz                    </span></span><br><span class="line">       20355933838      instructions:u            <span class="comment">#    2.62  insn per cycle         </span></span><br><span class="line">        4765061486      branches:u                <span class="comment"># 2074.938 M/sec                  </span></span><br><span class="line">          18856150      branch-misses:u           <span class="comment">#    0.40% of all branches        </span></span><br><span class="line"></span><br><span class="line">       2.298209049 seconds <span class="keyword">time</span> elapsed</span><br></pre></td></tr></table></figure>

<p>2.3 seconds seems not bad. But unfortunately it doesn’t pass the time limit. Let’s see the stack traces and knows what’s taking so long under the hood.</p>
<p>First collect stack traces with <code>perf record</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sampling at 199 Hz</span></span><br><span class="line"><span class="comment"># outputs a perf.data file</span></span><br><span class="line">$ perf record -F 199 --call-graph lbr ./main</span><br></pre></td></tr></table></figure>

<p>Then display caller-based graph report to stdout.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># read perf.data and display caller-based grapg report to stdout</span></span><br><span class="line">$ perf report --stdio</span><br></pre></td></tr></table></figure>

<p>Let’s first see the call graph of <code>combinationSum</code>. The call stack is deep and I have omitted some unrelevant calls for clarity.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Children      Self  Command  Shared Object        Symbol                           </span></span><br><span class="line"><span class="comment"># ........  ........  .......  ...................  .................................</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">    99.95%    26.07%  main     main                 [.] combinationSum</span><br><span class="line">            |          </span><br><span class="line">            |--73.88%--combinationSum</span><br><span class="line">            ...</span><br><span class="line">            |          combinationSum</span><br><span class="line">            |          combinationSum</span><br><span class="line">            |          |          </span><br><span class="line">            |          |--72.86%--combinationSum</span><br><span class="line">            |          |          |          </span><br><span class="line">            |          |          |--71.01%--combinationSum</span><br><span class="line">            |          |          |          |          </span><br><span class="line">            |          |          |          |--67.32%--combinationSum</span><br><span class="line">            |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |--58.50%--combinationSum</span><br><span class="line">            |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |--40.46%--combinationSum</span><br><span class="line">            |          |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |          |--15.59%--operator delete@plt</span><br><span class="line">            |          |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |          |--15.11%--operator new</span><br><span class="line">            |          |          |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |          |          |--7.61%--malloc@plt</span><br><span class="line">            |          |          |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |          |           --7.50%--malloc</span><br><span class="line">            |          |          |          |          |          |          |                     _int_malloc</span><br><span class="line">            |          |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |          |--7.92%--memcpy@plt</span><br><span class="line">            |          |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |           --1.85%--operator new@plt</span><br><span class="line">            |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |--7.79%--operator new</span><br><span class="line">            |          |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |          |--5.33%--malloc@plt</span><br><span class="line">            |          |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |           --2.46%--malloc</span><br><span class="line">            |          |          |          |          |          |                     _int_malloc</span><br><span class="line">            |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |--7.38%--operator delete@plt</span><br><span class="line">            |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |--2.25%--memcpy@plt</span><br><span class="line">            |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |           --0.61%--operator new@plt</span><br><span class="line">            |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |--4.31%--operator delete@plt</span><br><span class="line">            |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |--3.28%--operator new</span><br><span class="line">            |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |          |--2.05%--malloc@plt</span><br><span class="line">            |          |          |          |          |          |          </span><br><span class="line">            |          |          |          |          |           --1.23%--malloc</span><br><span class="line">            |          |          |          |          |                     _int_malloc</span><br><span class="line">            |          |          |          |          |          </span><br><span class="line">            |          |          |          |           --1.23%--memcpy@plt</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>

<p>As we can see, at each level of <code>combinationSum</code>, it is spending time to do the heap allocation, looking kinda suspicious.</p>
<p>To see the overall effect of heap allocation, we could turn to the callee-based graph.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ perf report --no-children --stdio</span><br></pre></td></tr></table></figure>

<p>And let’s look at the <code>malloc</code> part. Overall, we are spending 15.81% of time at <code>malloc</code>. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Overhead  Command  Shared Object        Symbol                 </span></span><br><span class="line"><span class="comment"># ........  .......  ...................  .......................</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">    15.81%  main     libc-2.17.so         [.] malloc</span><br><span class="line">            |</span><br><span class="line">            ---malloc@plt</span><br><span class="line">               operator new</span><br><span class="line">               combinationSum</span><br><span class="line">               ...</span><br><span class="line">               combinationSum</span><br><span class="line">               |          </span><br><span class="line">                --15.40%--combinationSum</span><br><span class="line">                          |          </span><br><span class="line">                           --14.99%--combinationSum</span><br><span class="line">                                     |          </span><br><span class="line">                                     |--14.38%--combinationSum</span><br><span class="line">                                     |          |          </span><br><span class="line">                                     |          |--12.53%--combinationSum</span><br><span class="line">                                     |          |          |          </span><br><span class="line">                                     |          |          |--7.41%--combinationSum</span><br><span class="line">                                     |          |          |          main</span><br><span class="line">                                     |          |          |          __libc_start_main</span><br><span class="line">                                     |          |          |          </span><br><span class="line">                                     |          |           --5.13%--main</span><br><span class="line">                                     |          |                     __libc_start_main</span><br><span class="line">                                     |          |          </span><br><span class="line">                                     |           --1.84%--main</span><br><span class="line">                                     |                     __libc_start_main</span><br><span class="line">                                     |          </span><br><span class="line">                                      --0.61%--main</span><br><span class="line">                                                __libc_start_main</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>For all memory operations, they take 64.67% of time </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Overhead  Command  Shared Object        Symbol                 </span></span><br><span class="line"><span class="comment"># ........  .......  ...................  .......................</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">    23.38%  main     libc-2.17.so         [.] _int_free</span><br><span class="line">    ...</span><br><span class="line">    15.81%  main     libc-2.17.so         [.] malloc</span><br><span class="line">    ...</span><br><span class="line">    12.63%  main     libc-2.17.so         [.] __memcpy_ssse3_back</span><br><span class="line">    ...</span><br><span class="line">    12.42%  main     libc-2.17.so         [.] _int_malloc</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>At this point, or maybe from earlier moments, we should be clear what’s the hotspot of this program. Each time <code>combinationSum</code> is called, <code>nums</code> is copied. It could be easily optimized by reusing the same vector <code>nums</code> for all <code>combinationSum</code> calls.</p>
<p>After optimization, it only takes 0.23s, 10 times faster, awesome!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Performance counter stats <span class="keyword">for</span> <span class="string">&#x27;main&#x27;</span>:</span><br><span class="line"></span><br><span class="line">       235.681078      task-clock:u (msec)       <span class="comment">#    0.993 CPUs utilized          </span></span><br><span class="line">                0      context-switches:u        <span class="comment">#    0.000 K/sec                  </span></span><br><span class="line">                0      cpu-migrations:u          <span class="comment">#    0.000 K/sec                  </span></span><br><span class="line">              103      page-faults:u             <span class="comment">#    0.437 K/sec                  </span></span><br><span class="line">        794405800      cycles:u                  <span class="comment">#    3.371 GHz                    </span></span><br><span class="line">       2518372430      instructions:u            <span class="comment">#    3.17  insn per cycle         </span></span><br><span class="line">        470069848      branches:u                <span class="comment">#    1994.517 M/sec                  </span></span><br><span class="line">           243573      branch-misses:u           <span class="comment">#    0.05% of all branches        </span></span><br><span class="line"></span><br><span class="line">      0.237236131 seconds <span class="keyword">time</span> elapsed</span><br></pre></td></tr></table></figure>

<p>And if we look at the call graphs, the memory operations all vanishes, because they are little to count. Note that for the callee-based graph, most of the samples will fall on the longest path (i.e., the path with the largest number of <code>combinationSum</code> calls).</p>
<p><strong>Spotting such mistake is easy when the size of the program is small. As the program scales and becomes complicated, the diffculty to spot such mistake increases drastically.</strong> At this point, the profiling tool will be our lovely friends to help us out.</p>
<h1 id="Excercise"><a href="#Excercise" class="headerlink" title="Excercise"></a>Excercise</h1><p>In the above case, we were capturing stack trace with lbr. Now I want to collect stack trace by frame pointers. First I am compiling with</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ g++ -g -fno-omit-frame-pointer -fno-omit-frame-pointer -fno-inline -o main main.cc</span><br></pre></td></tr></table></figure>

<p>And collect stack traces with</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ perf record -F 199 -g --call-graph fp ./main</span><br></pre></td></tr></table></figure>

<p>Here’s the report</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ perf report --stdio</span><br><span class="line"><span class="comment"># Children      Self  Command  Shared Object        Symbol                           </span></span><br><span class="line"><span class="comment"># ........  ........  .......  ...................  .................................</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">    56.00%     0.00%  main     main                 [.] main</span><br><span class="line">            |</span><br><span class="line">            ---main</span><br><span class="line">               combinationSum</span><br><span class="line">               combinationSum</span><br><span class="line">               combinationSum</span><br><span class="line">               combinationSum</span><br><span class="line">               combinationSum</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>In theory, most sample points should fall under <code>main</code> or the functions called by <code>main</code>, which sums up to near 100%. But it only gets 56%. Why?</p>
<details class="toggle" ><summary class="toggle-button" style="">Answer</summary><div class="toggle-content"><p>The system libraries were compiled without flags such as <code>-fno-omit-frame-pointer</code>. The stack traces couldn’t be captured correctly.</p>
</div></details>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.brendangregg.com/perf.html">https://www.brendangregg.com/perf.html</a></li>
<li><a target="_blank" rel="noopener" href="https://zh-blog.logan.tw/2019/10/06/intro-to-perf-events-and-call-graph/">https://zh-blog.logan.tw/2019/10/06/intro-to-perf-events-and-call-graph/</a></li>
<li>ChatGPT</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://kch042.github.io">8st</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章連結: </span><span class="post-copyright-info"><a href="https://kch042.github.io/posts/profiling-callgraph/">https://kch042.github.io/posts/profiling-callgraph/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版權聲明: </span><span class="post-copyright-info">本部落格所有文章除特別聲明外，均採用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 授權協議。轉載請註明來源 <a href="https://kch042.github.io" target="_blank">8st and the black cats</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/profiling/">profiling</a><a class="post-meta__tags" href="/tags/perf/">perf</a><a class="post-meta__tags" href="/tags/call-graph/">call graph</a></div><div class="post-share"><div class="social-share" data-image="/img/run.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/posts/pc-modern-processor/" title="Parallel Computing 1: Modern Processor Architecture"><img class="cover" src="/img/work.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Parallel Computing 1: Modern Processor Architecture</div></div><div class="info-2"><div class="info-item-1">This article aims to discuss some fundamental methods to increase the program speed, from the perspective of modern processor. This is also my study memo for Stanford CS149 Review What is a Program   A stream of hardware instructions to be exectuted    What is an Execution Context (or State)   A snapshot of register files, containing ordinary registers and PC.    What basic units does a processor have, and what is the basic flow of executing an instruction?   A simple CPU contains a...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/cpp.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">8st</div><div class="author-info-description">Hi, This is Buster. I love black cats!</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">28</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">5</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Perf-Tool"><span class="toc-number">1.</span> <span class="toc-text">Perf Tool</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Stack-Trace"><span class="toc-number">2.</span> <span class="toc-text">Stack Trace</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#fp"><span class="toc-number">2.1.</span> <span class="toc-text">fp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dwarf"><span class="toc-number">2.2.</span> <span class="toc-text">dwarf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lbr"><span class="toc-number">2.3.</span> <span class="toc-text">lbr</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Symbols"><span class="toc-number">3.</span> <span class="toc-text">Symbols</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Call-Graph"><span class="toc-number">4.</span> <span class="toc-text">Call Graph</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Example"><span class="toc-number">4.1.</span> <span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Case-Study-Combination-Sum"><span class="toc-number">5.</span> <span class="toc-text">Case Study: Combination Sum</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Excercise"><span class="toc-number">6.</span> <span class="toc-text">Excercise</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">7.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/profiling-callgraph/" title="Profiling - Call Graph"><img src="/img/run.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Profiling - Call Graph"/></a><div class="content"><a class="title" href="/posts/profiling-callgraph/" title="Profiling - Call Graph">Profiling - Call Graph</a><time datetime="2025-06-29T16:00:00.000Z" title="發表於 2025-06-30 00:00:00">2025-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/pc-modern-processor/" title="Parallel Computing 1: Modern Processor Architecture"><img src="/img/work.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Parallel Computing 1: Modern Processor Architecture"/></a><div class="content"><a class="title" href="/posts/pc-modern-processor/" title="Parallel Computing 1: Modern Processor Architecture">Parallel Computing 1: Modern Processor Architecture</a><time datetime="2025-02-22T16:00:00.000Z" title="發表於 2025-02-23 00:00:00">2025-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/cpp-inline/" title="C++ Inline"><img src="/img/cpp/cpp.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++ Inline"/></a><div class="content"><a class="title" href="/posts/cpp-inline/" title="C++ Inline">C++ Inline</a><time datetime="2024-10-27T16:00:00.000Z" title="發表於 2024-10-28 00:00:00">2024-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/cpp-lvalue-rvalue-move-swap-forward/" title="C++ lvalue, rvalue, move, swap, forward"><img src="/img/cpp/cpp.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++ lvalue, rvalue, move, swap, forward"/></a><div class="content"><a class="title" href="/posts/cpp-lvalue-rvalue-move-swap-forward/" title="C++ lvalue, rvalue, move, swap, forward">C++ lvalue, rvalue, move, swap, forward</a><time datetime="2024-05-17T16:00:00.000Z" title="發表於 2024-05-18 00:00:00">2024-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/cpp-template/" title="C++ Template"><img src="/img/cpp/cpp.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++ Template"/></a><div class="content"><a class="title" href="/posts/cpp-template/" title="C++ Template">C++ Template</a><time datetime="2024-02-24T16:00:00.000Z" title="發表於 2024-02-25 00:00:00">2024-02-25</time></div></div></div></div></div></div></main><footer id="footer" style="background: black;"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 8st</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日夜模式切換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到頂端"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div></div></body></html>